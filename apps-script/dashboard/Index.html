<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon Performance Dashboard</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f0f2f5;
            color: #1a1a1a;
            line-height: 1.5;
        }

        .header {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            color: white;
            padding: 20px 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .header-left h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .header-left .subtitle {
            opacity: 0.85;
            font-size: 14px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .date-picker {
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 6px;
            border: none;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            cursor: pointer;
        }

        .date-picker option {
            background: #1e3a5f;
            color: white;
        }

        .refresh-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }

        .refresh-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .card-header {
            background: #f8f9fa;
            padding: 16px 20px;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            font-size: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-body {
            padding: 20px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
        }

        .summary-item {
            text-align: center;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .summary-item .value {
            font-size: 28px;
            font-weight: 700;
            color: #1e3a5f;
        }

        .summary-item .label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        .region-section {
            margin-bottom: 24px;
        }

        .region-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e3a5f;
            margin-bottom: 12px;
            padding-left: 12px;
            border-left: 4px solid #2d5a87;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        th,
        td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .manager-cell {
            font-weight: 600;
            color: #1e3a5f;
            background: #e9f0f7 !important;
            border-bottom: 3px solid #1e3a5f !important;
        }

        /* Last row in RM group gets bottom border */
        tr.rm-group-end td {
            border-bottom: 3px solid #1e3a5f !important;
        }

        .metric-good {
            color: #0a7c42;
            background: #d4edda;
        }

        .metric-warn {
            color: #856404;
            background: #fff3cd;
        }

        .metric-bad {
            color: #a71d2a;
            background: #f8d7da;
        }

        td.metric-good,
        td.metric-warn,
        td.metric-bad {
            font-weight: 600;
            text-align: center;
        }

        .currency {
            font-family: 'SF Mono', Consolas, monospace;
            text-align: right;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }

        .timestamp {
            font-size: 12px;
            color: #666;
        }

        .history-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
        }

        /* Tab Navigation */
        .tab-nav {
            background: #fff;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            gap: 0;
            padding: 0 20px;
        }

        .tab-btn {
            padding: 14px 24px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: #1e3a5f;
            background: #f8f9fa;
        }

        .tab-btn.active {
            color: #1e3a5f;
            border-bottom-color: #2d5a87;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* INF Product Cards */
        .inf-controls {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .inf-select {
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 14px;
            min-width: 200px;
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .product-card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
        }

        .product-image {
            width: 100%;
            height: 160px;
            object-fit: contain;
            background: white;
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .product-details {
            padding: 14px;
        }

        .product-name {
            font-weight: 600;
            font-size: 14px;
            color: #1a1a1a;
            margin-bottom: 8px;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .product-sku {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }

        .product-stats {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .stat-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-inf {
            background: #f8d7da;
            color: #a71d2a;
        }

        .badge-stock {
            background: #d4edda;
            color: #0a7c42;
        }

        .badge-stock.low {
            background: #fff3cd;
            color: #856404;
        }

        .badge-stock.out {
            background: #f8d7da;
            color: #a71d2a;
        }

        .badge-price {
            background: #e9f0f7;
            color: #1e3a5f;
        }

        .product-location {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #eee;
        }

        .product-actions {
            padding: 10px 14px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
        }

        .product-link {
            display: inline-block;
            padding: 6px 12px;
            background: #1e3a5f;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .product-link:hover {
            background: #2d5a87;
        }

        .inf-empty {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .store-inf-rate {
            font-size: 14px;
            color: #666;
            margin-left: auto;
        }

        /* Worst performers highlighting */
        .worst-performer {
            background: #fff5f5 !important;
        }

        .worst-performer td:first-child::before {
            content: '‚ö†Ô∏è ';
        }

        .rank-badge {
            display: inline-block;
            background: #dc3545;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
            font-weight: 600;
        }

        /* Store search */
        .search-box {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            min-width: 200px;
        }

        .search-box:focus {
            outline: none;
            border-color: #1e3a5f;
            box-shadow: 0 0 0 2px rgba(30, 58, 95, 0.1);
        }

        .match-count {
            color: #666;
            font-size: 12px;
            margin-left: 8px;
        }

        /* Callout Cards */
        .callout-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            border-radius: 10px;
            flex: 1;
            min-width: 200px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        }

        .callout-icon {
            font-size: 24px;
        }

        .callout-content {
            flex: 1;
        }

        .callout-title {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .callout-value {
            font-size: 16px;
            font-weight: 700;
            margin: 2px 0;
        }

        .callout-detail {
            font-size: 12px;
            color: #666;
        }

        .callout-bad {
            background: linear-gradient(135deg, #fff5f5 0%, #ffe0e0 100%);
            border-left: 4px solid #dc3545;
        }

        .callout-bad .callout-value {
            color: #a71d2a;
        }

        .callout-good {
            background: linear-gradient(135deg, #f0fff4 0%, #d4edda 100%);
            border-left: 4px solid #28a745;
        }

        .callout-good .callout-value {
            color: #0a7c42;
        }

        .callout-warn {
            background: linear-gradient(135deg, #fffcf0 0%, #fff3cd 100%);
            border-left: 4px solid #ffc107;
        }

        .callout-warn .callout-value {
            color: #856404;
        }

        /* Trend Indicators */
        .trend {
            display: inline-block;
            font-size: 11px;
            margin-left: 4px;
            font-weight: 500;
        }

        .trend-up {
            color: #28a745;
        }

        .trend-down {
            color: #dc3545;
        }

        .trend-neutral {
            color: #6c757d;
        }

        .trend-up-bad {
            color: #dc3545;
        }

        .trend-down-good {
            color: #28a745;
        }

        /* Sortable Columns */
        th.sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 18px !important;
        }

        th.sortable:hover {
            background: #e2e6ea;
        }

        th.sortable::after {
            content: '‚áÖ';
            position: absolute;
            right: 4px;
            opacity: 0.3;
            font-size: 10px;
        }

        th.sortable.sort-asc::after {
            content: '‚Üë';
            opacity: 1;
        }

        th.sortable.sort-desc::after {
            content: '‚Üì';
            opacity: 1;
        }

        /* Store Drill-Down Links */
        .store-link {
            color: #1e3a5f;
            text-decoration: none;
            cursor: pointer;
            transition: color 0.2s;
        }

        .store-link:hover {
            color: #2980b9;
            text-decoration: underline;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 8px;
            }

            .header {
                flex-direction: column;
                text-align: center;
                padding: 12px;
                gap: 10px;
            }

            .header h1 {
                font-size: 18px;
            }

            .header-right {
                flex-wrap: wrap;
                justify-content: center;
                gap: 8px;
            }

            .date-picker {
                padding: 8px 12px;
                font-size: 14px;
            }

            .tab-nav {
                padding: 0;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .tab-btn {
                padding: 12px 16px;
                font-size: 13px;
                white-space: nowrap;
            }

            /* Filter controls stack on mobile */
            .card-body>div[style*="display: flex"] {
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 8px !important;
            }

            .search-box,
            .inf-select,
            select {
                width: 100%;
                min-width: unset;
            }

            /* Table responsiveness */
            table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                white-space: nowrap;
            }

            th,
            td {
                padding: 8px 6px;
                font-size: 11px;
            }

            /* Larger touch targets */
            button,
            .product-link,
            .tab-btn {
                min-height: 44px;
                min-width: 44px;
            }

            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .summary-item .value {
                font-size: 20px;
            }

            .product-grid {
                grid-template-columns: 1fr;
            }

            .product-card {
                margin-bottom: 8px;
            }

            .inf-controls {
                flex-direction: column;
                align-items: stretch !important;
            }

            .inf-controls label {
                margin: 0 0 4px 0 !important;
            }

            .inf-controls select {
                width: 100%;
            }
        }

        /* Tablet */
        @media (min-width: 769px) and (max-width: 1024px) {
            .summary-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .product-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="header-left">
            <h1>üìä Amazon Performance Dashboard</h1>
            <div class="subtitle" id="report-date">Loading...</div>
        </div>
        <div class="header-right">
            <select class="date-picker" id="date-selector" onchange="loadDate(this.value)">
                <option value="">Loading dates...</option>
            </select>
            <span class="history-badge" id="history-count"></span>
            <button class="refresh-btn" onclick="shareCurrentView()" title="Copy shareable link">üîó Share</button>
            <button class="refresh-btn" onclick="exportCSV()" title="Download CSV">üì• Export</button>
            <button class="refresh-btn" onclick="init()">‚ü≥ Refresh</button>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('performance')">üè™ Performance</button>
        <button class="tab-btn" onclick="switchTab('inf')">üì¶ Store INF</button>
        <button class="tab-btn" onclick="switchTab('network-inf')">üåê Network INF</button>
    </div>

    <!-- Performance Tab -->
    <div id="tab-performance" class="tab-content active">
        <div class="container">
            <!-- Summary Card -->
            <div class="card">
                <div class="card-header">
                    <span>Network Summary</span>
                    <span class="timestamp" id="last-updated"></span>
                </div>
                <div class="card-body">
                    <div class="summary-grid" id="summary-grid">
                        <div class="loading">Loading summary...</div>
                    </div>
                </div>
            </div>

            <!-- Quick Stats Callouts -->
            <div id="callout-container" style="display: flex; gap: 16px; margin-bottom: 16px; flex-wrap: wrap;"></div>

            <!-- Filter Bar -->
            <div class="card" style="margin-bottom: 16px;">
                <div class="card-body"
                    style="padding: 12px 20px; display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
                    <input type="text" id="store-search" placeholder="üîç Search stores..." class="search-box"
                        oninput="applyFilters()">
                    <select id="region-filter" onchange="applyFilters()"
                        style="padding: 6px 12px; border-radius: 6px; border: 1px solid #ddd; font-size: 13px;">
                        <option value="">All Regions</option>
                    </select>
                    <select id="manager-filter" onchange="applyFilters()"
                        style="padding: 6px 12px; border-radius: 6px; border: 1px solid #ddd; font-size: 13px;">
                        <option value="">All Managers</option>
                    </select>
                    <button onclick="clearFilters()"
                        style="padding: 6px 12px; background: #f0f2f5; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; font-size: 13px;">Clear</button>
                    <span id="filter-count" style="color: #666; font-size: 12px;"></span>
                </div>
            </div>

            <!-- Data Tables -->
            <div class="card">
                <div class="card-header">Store Performance by Region</div>
                <div class="card-body" id="regions-container">
                    <div class="loading">Loading store data...</div>
                </div>
            </div>
        </div>
    </div><!-- End Performance Tab -->

    <!-- INF Deep Dive Tab -->
    <div id="tab-inf" class="tab-content">
        <div class="container">
            <div class="card">
                <div class="card-header">
                    <span>üì¶ INF Items Deep Dive</span>
                </div>
                <div class="card-body">
                    <div class="inf-controls">
                        <label style="font-weight: 600;">Date:</label>
                        <select id="inf-date-selector" class="inf-select" onchange="loadINFData(this.value)">
                            <option value="">Loading dates...</option>
                        </select>
                        <label style="font-weight: 600; margin-left: 16px;">Store:</label>
                        <select id="inf-store-selector" class="inf-select" onchange="renderINFProducts(this.value)">
                            <option value="">Select a store</option>
                        </select>
                        <span class="store-inf-rate" id="store-inf-rate"></span>
                    </div>
                    <div id="inf-products-container">
                        <div class="inf-empty">Select a date and store to view INF items</div>
                    </div>
                </div>
            </div>
        </div>
    </div><!-- End INF Tab -->

    <!-- Network INF Tab -->
    <div id="tab-network-inf" class="tab-content">
        <div class="container">
            <!-- Summary Stats -->
            <div class="card">
                <div class="card-header">
                    <span>üåê Network-Wide INF Summary</span>
                    <span class="timestamp" id="network-inf-date"></span>
                </div>
                <div class="card-body">
                    <div class="summary-grid" id="network-inf-summary">
                        <div class="loading">Loading summary...</div>
                    </div>
                </div>
            </div>

            <!-- Filters & Sort -->
            <div class="card" style="margin-bottom: 16px;">
                <div class="card-body" style="padding: 12px 20px;">
                    <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
                        <input type="text" id="inf-search" placeholder="Search product or SKU..."
                            oninput="filterNetworkINF()"
                            style="padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd; font-size: 13px; min-width: 200px;">
                        <select id="inf-store-filter" onchange="filterNetworkINF()"
                            style="padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd; font-size: 13px;">
                            <option value="">All Stores</option>
                        </select>
                        <select id="inf-stock-filter" onchange="filterNetworkINF()"
                            style="padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd; font-size: 13px;">
                            <option value="">All Stock</option>
                            <option value="out">Out of Stock</option>
                            <option value="low">Low Stock</option>
                            <option value="ok">In Stock</option>
                        </select>
                        <select id="inf-sort" onchange="filterNetworkINF()"
                            style="padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd; font-size: 13px;">
                            <option value="inf-desc">INF: High to Low</option>
                            <option value="inf-asc">INF: Low to High</option>
                            <option value="stock-asc">Stock: Low to High</option>
                            <option value="stock-desc">Stock: High to Low</option>
                            <option value="store">Store A-Z</option>
                            <option value="name">Product A-Z</option>
                        </select>
                        <button onclick="exportNetworkINF()"
                            style="padding: 8px 12px; background: #1e3a5f; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">Export
                            CSV</button>
                        <span id="network-inf-count" style="color: #666; font-size: 12px; margin-left: auto;"></span>
                    </div>
                </div>
            </div>

            <!-- Data Table -->
            <div class="card">
                <div class="card-body" style="overflow-x: auto;">
                    <table id="network-inf-table">
                        <thead>
                            <tr>
                                <th style="width: 60px;">Image</th>
                                <th>Product</th>
                                <th>Store</th>
                                <th style="width: 70px;">INF</th>
                                <th style="width: 80px;">Stock</th>
                                <th style="width: 70px;">Price</th>
                                <th>Location</th>
                                <th style="width: 100px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="network-inf-tbody">
                            <tr>
                                <td colspan="8" class="loading">Click Network INF tab to load data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div><!-- End Network INF Tab -->

    <script>
        let availableDates = [];
        let currentDate = null;
        let selectedRegion = '';
        let selectedManager = '';
        let storeSearch = '';
        let sortColumn = 'inf_wtd';
        let sortDirection = 'desc';

        function populateFilters(data) {
            const regionSelect = document.getElementById('region-filter');
            const managerSelect = document.getElementById('manager-filter');

            if (!data.regions) return;

            // Get unique regions (sorted)
            const regions = Object.keys(data.regions).filter(r => r !== 'Unknown').sort();
            regionSelect.innerHTML = '';
            let opt = document.createElement('option');
            opt.value = '';
            opt.textContent = 'All Regions';
            regionSelect.appendChild(opt);
            regions.forEach(r => {
                opt = document.createElement('option');
                opt.value = r;
                opt.textContent = r;
                regionSelect.appendChild(opt);
            });

            // Get all managers
            let allManagers = new Set();
            for (const [region, managers] of Object.entries(data.regions)) {
                for (const manager of Object.keys(managers)) {
                    allManagers.add(manager);
                }
            }
            const sortedManagers = [...allManagers].sort();
            managerSelect.innerHTML = '';
            opt = document.createElement('option');
            opt.value = '';
            opt.textContent = 'All Managers';
            managerSelect.appendChild(opt);
            sortedManagers.forEach(m => {
                opt = document.createElement('option');
                opt.value = m;
                opt.textContent = m;
                managerSelect.appendChild(opt);
            });
        }

        function applyFilters() {
            selectedRegion = document.getElementById('region-filter').value;
            selectedManager = document.getElementById('manager-filter').value;
            storeSearch = (document.getElementById('store-search')?.value || '').toLowerCase();

            if (lastReportData) {
                renderRegionsFiltered(lastReportData);
            }
            updateUrlState();
        }

        function clearFilters() {
            document.getElementById('region-filter').value = '';
            document.getElementById('manager-filter').value = '';
            document.getElementById('store-search').value = '';
            selectedRegion = '';
            selectedManager = '';
            storeSearch = '';
            if (lastReportData) {
                renderRegionsFiltered(lastReportData);
            }
            updateUrlState();
        }

        function renderRegionsFiltered(data) {
            const regions = data.regions || {};
            let html = '';
            let storeCount = 0;
            let allStores = [];

            // Column definitions for sorting
            const columns = [
                { key: 'store', label: 'Store', sortable: false },
                { key: 'inf_y', label: 'INF Yest', sortable: true },
                { key: 'inf_wtd', label: 'INF Week', sortable: true },
                { key: 'lates_y', label: 'Lates Yest', sortable: true },
                { key: 'lates_wtd', label: 'Lates Week', sortable: true },
                { key: 'uph_y', label: 'UPH Yest', sortable: true },
                { key: 'uph_wtd', label: 'UPH Week', sortable: true },
                { key: 'avc_y', label: 'AvC Yest', sortable: true },
                { key: 'avc_wtd', label: 'AvC Week', sortable: true },
                { key: 'avr_wtd', label: 'AvR Week', sortable: true },
                { key: 'wasted_payroll', label: 'Wasted ¬£', sortable: true },
                { key: 'missed_sales', label: 'Missed ¬£', sortable: true }
            ];

            // Collect all stores
            for (const [regionName, managers] of Object.entries(regions)) {
                if (regionName === 'Unknown') continue;
                if (selectedRegion && regionName !== selectedRegion) continue;

                for (const [managerName, stores] of Object.entries(managers)) {
                    if (selectedManager && managerName !== selectedManager) continue;

                    for (const store of stores) {
                        if (storeSearch && !(store.store || '').toLowerCase().includes(storeSearch)) continue;

                        allStores.push({
                            ...store,
                            regionName,
                            managerName,
                            infValue: store.inf_wtd ?? store.inf_y ?? 0
                        });
                    }
                }
            }

            // Sort stores
            allStores.sort((a, b) => {
                const aVal = a[sortColumn] ?? 0;
                const bVal = b[sortColumn] ?? 0;
                if (sortDirection === 'asc') return aVal - bVal;
                return bVal - aVal;
            });

            // Mark top 3 worst INF
            const sortedByInf = [...allStores].sort((a, b) => b.infValue - a.infValue);
            const worstStoreNames = sortedByInf.slice(0, 3).map(s => s.store);

            storeCount = allStores.length;

            // Build header with sortable columns
            function buildHeader() {
                let h = '<th>RM</th>';
                columns.forEach(col => {
                    if (col.sortable) {
                        const sortClass = sortColumn === col.key ? (sortDirection === 'asc' ? 'sort-asc' : 'sort-desc') : '';
                        h += '<th class="sortable ' + sortClass + '" onclick="sortBy(\'' + col.key + '\')">' + col.label + '</th>';
                    } else {
                        h += '<th>' + col.label + '</th>';
                    }
                });
                return h;
            }

            // Group by region, then by manager
            const byRegion = {};
            allStores.forEach(store => {
                if (!byRegion[store.regionName]) byRegion[store.regionName] = {};
                if (!byRegion[store.regionName][store.managerName]) byRegion[store.regionName][store.managerName] = [];
                byRegion[store.regionName][store.managerName].push(store);
            });

            for (const [regionName, managers] of Object.entries(byRegion)) {
                let regionHtml = '';

                for (const [managerName, stores] of Object.entries(managers)) {
                    // Sort stores within manager group
                    stores.sort((a, b) => {
                        const aVal = a[sortColumn] ?? 0;
                        const bVal = b[sortColumn] ?? 0;
                        if (sortDirection === 'asc') return aVal - bVal;
                        return bVal - aVal;
                    });

                    stores.forEach((store, idx) => {
                        const isWorst = worstStoreNames.includes(store.store);
                        const isLastInGroup = idx === stores.length - 1;
                        let rowClass = isWorst ? 'worst-performer' : '';
                        if (isLastInGroup) rowClass += ' rm-group-end';
                        const rankBadge = isWorst ? '<span class="rank-badge">Top 3 INF</span>' : '';

                        regionHtml += '<tr class="' + rowClass.trim() + '">';
                        if (idx === 0) {
                            regionHtml += '<td class="manager-cell" rowspan="' + stores.length + '">' + managerName + '</td>';
                        }
                        regionHtml += '<td><a class="store-link" href="#" onclick="drillDownToStoreINF(\'' + (store.store || '').replace(/'/g, "\\'") + '\'); return false;">' + (store.store || '') + '</a>' + rankBadge + '</td>';
                        regionHtml += '<td class="' + getMetricClass(store.inf_y, 2, 3, false) + '">' + formatPercent(store.inf_y) + '</td>';
                        regionHtml += '<td class="' + getMetricClass(store.inf_wtd, 2, 3, false) + '">' + formatPercent(store.inf_wtd) + '</td>';
                        regionHtml += '<td class="' + getMetricClass(store.lates_y, 0.5, 2, false) + '">' + formatPercent(store.lates_y) + '</td>';
                        regionHtml += '<td class="' + getMetricClass(store.lates_wtd, 0.5, 2, false) + '">' + formatPercent(store.lates_wtd) + '</td>';
                        regionHtml += '<td class="' + getMetricClass(store.uph_y, 90, 80, true) + '">' + (store.uph_y || '-') + '</td>';
                        regionHtml += '<td class="' + getMetricClass(store.uph_wtd, 90, 80, true) + '">' + (store.uph_wtd || '-') + '</td>';
                        regionHtml += '<td class="' + getMetricClass(store.avc_y, 95, 85, true) + '">' + formatPercent(store.avc_y) + '</td>';
                        regionHtml += '<td class="' + getMetricClass(store.avc_wtd, 95, 85, true) + '">' + formatPercent(store.avc_wtd) + '</td>';
                        regionHtml += '<td class="' + getMetricClass(store.avr_wtd, 95, 85, true) + '">' + formatPercent(store.avr_wtd) + '</td>';
                        regionHtml += '<td class="currency">' + formatCurrency(store.wasted_payroll) + '</td>';
                        regionHtml += '<td class="currency">' + formatCurrency(store.missed_sales) + '</td>';
                        regionHtml += '</tr>';
                    });
                }

                html += '<div class="region-section">';
                html += '<div class="region-title">' + regionName + ' Region</div>';
                html += '<table><thead><tr>' + buildHeader() + '</tr></thead><tbody>' + regionHtml + '</tbody></table></div>';
            }

            if (!html) {
                html = '<div class="loading">No matching stores</div>';
            }

            document.getElementById('regions-container').innerHTML = html;
            document.getElementById('filter-count').innerText = 'Showing ' + storeCount + ' stores';
        }

        function sortBy(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'desc';
            }
            if (lastReportData) {
                renderRegionsFiltered(lastReportData);
            }
        }


        function formatCurrency(value) {
            if (!value || value === 0) return '-';
            return '¬£' + Math.round(value).toLocaleString();
        }

        function formatPercent(value) {
            if (value === null || value === undefined) return '-';
            return value.toFixed(1) + '%';
        }

        function getMetricClass(value, goodThreshold, badThreshold, higherIsBetter) {
            if (value === null || value === undefined) return '';
            if (higherIsBetter) {
                if (value >= goodThreshold) return 'metric-good';
                if (value < badThreshold) return 'metric-bad';
                return 'metric-warn';
            } else {
                if (value <= goodThreshold) return 'metric-good';
                if (value > badThreshold) return 'metric-bad';
                return 'metric-warn';
            }
        }

        function formatDateDisplay(dateStr) {
            const d = new Date(dateStr);
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return days[d.getDay()] + ' ' + d.getDate() + ' ' + months[d.getMonth()];
        }

        function populateDatePicker(dates, selectedDate) {
            const selector = document.getElementById('date-selector');
            selector.innerHTML = '';
            dates.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d;
                opt.textContent = formatDateDisplay(d);
                if (d === selectedDate) opt.selected = true;
                selector.appendChild(opt);
            });

            document.getElementById('history-count').innerText = dates.length + ' days';
        }

        function renderSummary(data) {
            const summary = data.summary || {};
            const prevSummary = data.prev_summary || null;
            const regions = data.regions || {};

            // Calculate best/worst performers
            let allStores = [];
            for (const [regionName, managers] of Object.entries(regions)) {
                if (regionName === 'Unknown') continue;
                for (const [managerName, stores] of Object.entries(managers)) {
                    for (const store of stores) {
                        allStores.push({
                            name: store.store,
                            inf: store.inf_wtd ?? store.inf_y ?? 0,
                            uph: store.uph_wtd ?? store.uph_y ?? 0
                        });
                    }
                }
            }

            // Sort by INF to find worst and best
            allStores.sort((a, b) => b.inf - a.inf);
            const worstStore = allStores[0];
            const bestStore = allStores[allStores.length - 1];
            const aboveThreshold = allStores.filter(s => s.inf > 2).length;

            // Helper for trend indicators (lower is better for INF/Lates, higher is better for UPH)
            function getTrend(current, previous, lowerIsBetter) {
                if (previous == null || current == null) return '';
                const diff = current - previous;
                if (Math.abs(diff) < 0.1) return '<span class="trend trend-neutral">‚Äî</span>';
                if (lowerIsBetter) {
                    if (diff < 0) return '<span class="trend trend-down-good">‚Üì' + Math.abs(diff).toFixed(1) + '</span>';
                    return '<span class="trend trend-up-bad">‚Üë' + diff.toFixed(1) + '</span>';
                } else {
                    if (diff > 0) return '<span class="trend trend-up">‚Üë' + diff.toFixed(1) + '</span>';
                    return '<span class="trend trend-down">‚Üì' + Math.abs(diff).toFixed(1) + '</span>';
                }
            }

            let html = '';

            // Main stats row
            html += '<div class="summary-item">';
            html += '<div class="value">' + (data.stores_count || 0) + '</div>';
            html += '<div class="label">Stores</div>';
            html += '</div>';
            html += '<div class="summary-item">';
            html += '<div class="value">' + formatPercent(summary.avg_inf) + getTrend(summary.avg_inf, prevSummary?.avg_inf, true) + '</div>';
            html += '<div class="label">Avg INF</div>';
            html += '</div>';
            html += '<div class="summary-item">';
            html += '<div class="value">' + formatPercent(summary.avg_lates) + getTrend(summary.avg_lates, prevSummary?.avg_lates, true) + '</div>';
            html += '<div class="label">Avg Lates</div>';
            html += '</div>';
            html += '<div class="summary-item">';
            html += '<div class="value">' + (summary.avg_uph ? Math.round(summary.avg_uph) : '-') + getTrend(summary.avg_uph, prevSummary?.avg_uph, false) + '</div>';
            html += '<div class="label">Avg UPH</div>';
            html += '</div>';
            html += '<div class="summary-item">';
            html += '<div class="value">' + formatCurrency(summary.total_wasted_payroll) + '</div>';
            html += '<div class="label">Wasted Payroll</div>';
            html += '</div>';
            html += '<div class="summary-item">';
            html += '<div class="value">' + formatCurrency(summary.total_missed_sales) + '</div>';
            html += '<div class="label">Missed Sales</div>';
            html += '</div>';

            document.getElementById('summary-grid').innerHTML = html;

            // Render callout cards
            let calloutHtml = '';
            if (worstStore) {
                calloutHtml += '<div class="callout-card callout-bad">';
                calloutHtml += '<div class="callout-icon">‚ö†Ô∏è</div>';
                calloutHtml += '<div class="callout-content">';
                calloutHtml += '<div class="callout-title">Highest INF</div>';
                calloutHtml += '<div class="callout-value">' + worstStore.name + '</div>';
                calloutHtml += '<div class="callout-detail">INF: ' + formatPercent(worstStore.inf) + '</div>';
                calloutHtml += '</div></div>';
            }
            if (bestStore && bestStore.name !== worstStore?.name) {
                calloutHtml += '<div class="callout-card callout-good">';
                calloutHtml += '<div class="callout-icon">üèÜ</div>';
                calloutHtml += '<div class="callout-content">';
                calloutHtml += '<div class="callout-title">Lowest INF</div>';
                calloutHtml += '<div class="callout-value">' + bestStore.name + '</div>';
                calloutHtml += '<div class="callout-detail">INF: ' + formatPercent(bestStore.inf) + '</div>';
                calloutHtml += '</div></div>';
            }
            if (aboveThreshold > 0) {
                calloutHtml += '<div class="callout-card callout-warn">';
                calloutHtml += '<div class="callout-icon">üìä</div>';
                calloutHtml += '<div class="callout-content">';
                calloutHtml += '<div class="callout-title">Above 2% INF</div>';
                calloutHtml += '<div class="callout-value">' + aboveThreshold + ' stores</div>';
                calloutHtml += '<div class="callout-detail">Need attention</div>';
                calloutHtml += '</div></div>';
            }

            const calloutContainer = document.getElementById('callout-container');
            if (calloutContainer) {
                calloutContainer.innerHTML = calloutHtml;
            }
        }

        function renderRegions(data) {
            const regions = data.regions || {};
            let html = '';

            for (const [regionName, managers] of Object.entries(regions)) {
                if (regionName === 'Unknown') continue;

                html += '<div class="region-section">';
                html += '<div class="region-title">' + regionName + ' Region</div>';
                html += '<table><thead><tr>';
                html += '<th>RM</th><th>Store</th>';
                html += '<th>INF Yest</th><th>INF Week</th>';
                html += '<th>Lates Yest</th><th>Lates Week</th>';
                html += '<th>UPH Yest</th><th>UPH Week</th>';
                html += '<th>AvC Yest</th><th>AvC Week</th><th>AvR Week</th>';
                html += '<th>Wasted ¬£</th><th>Missed ¬£</th>';
                html += '</tr></thead><tbody>';

                for (const [managerName, stores] of Object.entries(managers)) {
                    stores.forEach((store, idx) => {
                        const isLastInGroup = idx === stores.length - 1;
                        const rowClass = isLastInGroup ? 'rm-group-end' : '';
                        html += '<tr class="' + rowClass + '">';
                        if (idx === 0) {
                            html += '<td class="manager-cell" rowspan="' + stores.length + '">' + managerName + '</td>';
                        }
                        html += '<td><a class="store-link" href="#" onclick="drillDownToStoreINF(\'' + (store.store || '').replace(/'/g, "\\'") + '\'); return false;">' + (store.store || '') + '</a></td>';
                        html += '<td class="' + getMetricClass(store.inf_y, 2, 3, false) + '">' + formatPercent(store.inf_y) + '</td>';
                        html += '<td class="' + getMetricClass(store.inf_wtd, 2, 3, false) + '">' + formatPercent(store.inf_wtd) + '</td>';
                        html += '<td class="' + getMetricClass(store.lates_y, 0.5, 2, false) + '">' + formatPercent(store.lates_y) + '</td>';
                        html += '<td class="' + getMetricClass(store.lates_wtd, 0.5, 2, false) + '">' + formatPercent(store.lates_wtd) + '</td>';
                        html += '<td class="' + getMetricClass(store.uph_y, 90, 80, true) + '">' + (store.uph_y || '-') + '</td>';
                        html += '<td class="' + getMetricClass(store.uph_wtd, 90, 80, true) + '">' + (store.uph_wtd || '-') + '</td>';
                        html += '<td class="' + getMetricClass(store.avc_y, 95, 85, true) + '">' + formatPercent(store.avc_y) + '</td>';
                        html += '<td class="' + getMetricClass(store.avc_wtd, 95, 85, true) + '">' + formatPercent(store.avc_wtd) + '</td>';
                        html += '<td class="' + getMetricClass(store.avr_wtd, 95, 85, true) + '">' + formatPercent(store.avr_wtd) + '</td>';
                        html += '<td class="currency">' + formatCurrency(store.wasted_payroll) + '</td>';
                        html += '<td class="currency">' + formatCurrency(store.missed_sales) + '</td>';
                        html += '</tr>';
                    });
                }

                html += '</tbody></table></div>';
            }

            if (!html) {
                html = '<div class="loading">No region data available</div>';
            }

            document.getElementById('regions-container').innerHTML = html;
        }

        function loadDate(dateStr) {
            currentDate = dateStr;
            document.getElementById('summary-grid').innerHTML = '<div class="loading">Loading...</div>';
            document.getElementById('regions-container').innerHTML = '<div class="loading">Loading...</div>';

            google.script.run
                .withSuccessHandler(handleReportData)
                .withFailureHandler(handleError)
                .getReportForDate(dateStr);

            updateUrlState();
        }

        function handleReportData(data) {
            if (!data.ok) {
                document.getElementById('summary-grid').innerHTML = '<div class="error">' + data.message + '</div>';
                document.getElementById('regions-container').innerHTML = '';
                return;
            }

            currentDate = data.report_date;
            document.getElementById('report-date').innerText = 'Report for: ' + formatDateDisplay(data.report_date);
            document.getElementById('last-updated').innerText = 'Updated: ' + new Date(data.timestamp).toLocaleString();

            if (data.available_dates) {
                populateDatePicker(data.available_dates, currentDate);
            }

            populateFilters(data);
            renderSummary(data);
            renderRegionsFiltered(data);
        }

        function handleError(error) {
            document.getElementById('summary-grid').innerHTML = '<div class="error">Error: ' + error.message + '</div>';
        }

        // URL State Management
        let currentTab = 'performance';

        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                date: params.get('date'),
                tab: params.get('tab'),
                region: params.get('region'),
                manager: params.get('manager')
            };
        }

        function updateUrlState() {
            const params = new URLSearchParams();
            if (currentDate) params.set('date', currentDate);
            if (currentTab && currentTab !== 'performance') params.set('tab', currentTab);
            if (selectedRegion) params.set('region', selectedRegion);
            if (selectedManager) params.set('manager', selectedManager);

            const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
            window.history.replaceState({}, '', newUrl);
        }

        function shareCurrentView() {
            const params = new URLSearchParams();
            if (currentDate) params.set('date', currentDate);
            if (currentTab && currentTab !== 'performance') params.set('tab', currentTab);
            if (selectedRegion) params.set('region', selectedRegion);
            if (selectedManager) params.set('manager', selectedManager);

            const shareUrl = window.location.origin + window.location.pathname + (params.toString() ? '?' + params.toString() : '');

            if (navigator.clipboard) {
                navigator.clipboard.writeText(shareUrl).then(function () {
                    alert('Link copied to clipboard!');
                }).catch(function () {
                    prompt('Copy this link:', shareUrl);
                });
            } else {
                prompt('Copy this link:', shareUrl);
            }
        }

        function init() {
            // Parse URL params for deep linking
            const urlParams = getUrlParams();

            // Apply URL params to filters
            if (urlParams.region) {
                selectedRegion = urlParams.region;
                const regionSelect = document.getElementById('region-filter');
                if (regionSelect) regionSelect.value = urlParams.region;
            }
            if (urlParams.manager) {
                selectedManager = urlParams.manager;
                const managerSelect = document.getElementById('manager-filter');
                if (managerSelect) managerSelect.value = urlParams.manager;
            }
            if (urlParams.tab) {
                currentTab = urlParams.tab;
            }

            // If date specified, load that date; otherwise latest
            if (urlParams.date) {
                google.script.run
                    .withSuccessHandler(function (data) {
                        handleReportData(data);
                        // Switch to requested tab after data loads
                        if (urlParams.tab) switchTab(urlParams.tab);
                    })
                    .withFailureHandler(handleError)
                    .getReportForDate(urlParams.date);
            } else {
                google.script.run
                    .withSuccessHandler(function (data) {
                        handleReportData(data);
                        if (urlParams.tab) switchTab(urlParams.tab);
                    })
                    .withFailureHandler(handleError)
                    .getLatestReportData();
            }
        }

        // CSV Export functionality
        let lastReportData = null;

        function exportCSV() {
            if (!lastReportData || !lastReportData.regions) {
                alert('No data to export. Please wait for data to load.');
                return;
            }

            const regions = lastReportData.regions;
            const rows = [];

            // Header
            rows.push([
                'Region', 'Manager', 'Store',
                'INF Yesterday', 'INF WTD',
                'Lates Yesterday', 'Lates WTD',
                'UPH Yesterday', 'UPH WTD',
                'AvC Yesterday', 'AvC WTD', 'AvR WTD',
                'Wasted Payroll', 'Missed Sales'
            ].join(','));

            // Data rows
            for (const [regionName, managers] of Object.entries(regions)) {
                for (const [managerName, stores] of Object.entries(managers)) {
                    for (const store of stores) {
                        rows.push([
                            `"${regionName}"`,
                            `"${managerName}"`,
                            `"${store.store || ''}"`,
                            store.inf_y ?? '',
                            store.inf_wtd ?? '',
                            store.lates_y ?? '',
                            store.lates_wtd ?? '',
                            store.uph_y ?? '',
                            store.uph_wtd ?? '',
                            store.avc_y ?? '',
                            store.avc_wtd ?? '',
                            store.avr_wtd ?? '',
                            store.wasted_payroll ?? '',
                            store.missed_sales ?? ''
                        ].join(','));
                    }
                }
            }

            const csv = rows.join('\n');
            const filename = `performance_report_${currentDate || 'export'}.csv`;
            downloadFile(csv, filename, 'text/csv');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Store report data for export
        const originalHandleReportData = handleReportData;
        handleReportData = function (data) {
            lastReportData = data;
            originalHandleReportData(data);
        };

        // ===== INF Deep Dive Functions =====
        let currentINFData = null;

        let networkINFItems = [];
        let networkINFFiltered = [];

        function switchTab(tabName) {
            currentTab = tabName;

            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                const text = btn.textContent.toLowerCase();
                let isActive = false;
                if (tabName === 'performance' && text.includes('performance')) isActive = true;
                if (tabName === 'inf' && text.includes('store')) isActive = true;
                if (tabName === 'network-inf' && text.includes('network')) isActive = true;
                btn.classList.toggle('active', isActive);
            });

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById('tab-' + tabName).classList.add('active');

            // Load INF dates on first switch to INF tabs
            if (tabName === 'inf' && !currentINFData) {
                loadINFDates();
            }
            if (tabName === 'network-inf' && networkINFItems.length === 0) {
                loadNetworkINFData();
            }

            updateUrlState();
        }

        function drillDownToStoreINF(storeName) {
            // Switch to the Network INF tab
            switchTab('network-inf');

            // Wait for data to load if needed, then set the filter
            function applyStoreFilter() {
                const storeFilterSelect = document.getElementById('inf-store-filter');
                if (storeFilterSelect) {
                    // Find and select the matching store option
                    for (let i = 0; i < storeFilterSelect.options.length; i++) {
                        if (storeFilterSelect.options[i].value === storeName) {
                            storeFilterSelect.value = storeName;
                            filterNetworkINF();
                            return;
                        }
                    }
                    // If not found, it might still be loading - wait and retry
                    if (networkINFItems.length === 0) {
                        setTimeout(applyStoreFilter, 300);
                    }
                }
            }

            // Give a brief moment for the tab to switch and data to potentially load
            setTimeout(applyStoreFilter, 100);
        }

        function loadINFDates() {
            google.script.run
                .withSuccessHandler(function (result) {
                    const select = document.getElementById('inf-date-selector');
                    if (result.ok && result.dates && result.dates.length > 0) {
                        // Use DOM methods to avoid < parsing issues
                        select.innerHTML = '';
                        result.dates.forEach((d, i) => {
                            const opt = document.createElement('option');
                            opt.value = d;
                            opt.textContent = formatDate(d);
                            if (i === 0) opt.selected = true;
                            select.appendChild(opt);
                        });
                        loadINFData(result.dates[0]);
                    } else {
                        select.innerHTML = '';
                        const opt = document.createElement('option');
                        opt.value = '';
                        opt.textContent = 'No INF data available';
                        select.appendChild(opt);
                        document.getElementById('inf-products-container').innerHTML =
                            'No INF data has been collected yet. Run an INF analysis to populate this data.';
                    }
                })
                .withFailureHandler(function (err) {
                    console.error('Failed to load INF dates:', err);
                })
                .getINFDates();
        }

        function loadINFData(dateKey) {
            if (!dateKey) return;

            const container = document.getElementById('inf-products-container');
            container.innerHTML = 'Loading INF data...';

            google.script.run
                .withSuccessHandler(function (result) {
                    if (result.ok && result.stores) {
                        currentINFData = result.stores;
                        renderStoreSelector(result.stores);
                    } else {
                        container.innerHTML = result.message || 'No data available';
                    }
                })
                .withFailureHandler(function (err) {
                    container.innerHTML = 'Error loading data: ' + err;
                })
                .getINFItemsForDate(dateKey);
        }

        function renderStoreSelector(stores) {
            const select = document.getElementById('inf-store-selector');
            const storeNames = Object.keys(stores).sort();

            select.innerHTML = '';
            const defaultOpt = document.createElement('option');
            defaultOpt.value = '';
            defaultOpt.textContent = 'Select a store (' + storeNames.length + ' stores)';
            select.appendChild(defaultOpt);

            storeNames.forEach(name => {
                const itemCount = stores[name].items?.length || 0;
                const opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name + ' (' + itemCount + ' items)';
                select.appendChild(opt);
            });

            document.getElementById('inf-products-container').innerHTML = 'Select a store to view INF items';
            document.getElementById('store-inf-rate').textContent = '';
        }

        function renderINFProducts(storeName) {
            const container = document.getElementById('inf-products-container');
            const rateSpan = document.getElementById('store-inf-rate');

            if (!storeName || !currentINFData || !currentINFData[storeName]) {
                container.innerHTML = 'Select a store to view INF items';
                rateSpan.textContent = '';
                return;
            }

            const storeData = currentINFData[storeName];
            const items = storeData.items || [];
            const infRate = storeData.inf_rate;

            rateSpan.textContent = infRate ? 'INF Rate: ' + infRate + '%' : '';

            if (items.length === 0) {
                container.innerHTML = 'No INF items found for this store';
                return;
            }

            const placeholderImg = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cmVjdCBmaWxsPSIjZjBmMGYwIiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iIGZpbGw9IiM5OTkiIGZvbnQtc2l6ZT0iMTAiPk5vIEltYWdlPC90ZXh0Pjwvc3ZnPg==';

            // Build cards using DOM
            const grid = document.createElement('div');
            grid.className = 'product-grid';

            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'product-card';

                const stockVal = item.stock ?? 'N/A';
                let stockClass = 'badge-stock';
                if (typeof stockVal === 'number') {
                    if (stockVal === 0) stockClass += ' out';
                    else if (stockVal < 5) stockClass += ' low';
                }

                const analysisUrl = item.sku ? 'https://app.218.team/assistant/' + item.sku + '?locationId=' + (storeData.store_number || '') : '';

                let html = '';
                html += '<img class="product-image" src="' + (item.image_url || placeholderImg) + '" onerror="this.src=\'' + placeholderImg + '\'" />';
                html += '<div class="product-details">';
                html += '<div class="product-name">' + (item.name || 'Unknown Product') + '</div>';
                html += '<div class="product-sku">SKU: ' + (item.sku || 'N/A') + (item.barcode ? ' ‚Ä¢ EAN: ' + item.barcode : '') + '</div>';
                html += '<div class="product-stats">';
                html += '<span class="stat-badge badge-inf">INF: ' + (item.inf_count ?? 'N/A') + '</span>';
                html += '<span class="stat-badge ' + stockClass + '">Stock: ' + stockVal + '</span>';
                if (item.price) html += '<span class="stat-badge badge-price">¬£' + item.price.toFixed(2) + '</span>';
                html += '</div>';
                if (item.location) html += '<div class="product-location">üìç ' + item.location + '</div>';
                if (item.discontinued) html += '<div class="product-location" style="color: #a71d2a;">‚ö†Ô∏è Discontinued / Not Ranged</div>';
                html += '</div>';
                if (analysisUrl) {
                    html += '<div class="product-actions">';
                    html += '<a href="' + analysisUrl + '" target="_blank" class="product-link">üîç Analyze</a>';
                    html += '</div>';
                }

                card.innerHTML = html;
                grid.appendChild(card);
            });

            container.innerHTML = '';
            container.appendChild(grid);
        }

        // ===== Network INF Functions =====
        function loadNetworkINFData() {
            const tbody = document.getElementById('network-inf-tbody');
            const summary = document.getElementById('network-inf-summary');
            tbody.innerHTML = '<tr><td colspan="8">Loading network INF data...</td></tr>';
            summary.innerHTML = 'Loading...';

            google.script.run
                .withSuccessHandler(function (result) {
                    if (!result.ok || !result.dates || result.dates.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="8">No INF data available</td></tr>';
                        return;
                    }
                    const latestDate = result.dates[0];
                    document.getElementById('network-inf-date').textContent = formatDate(latestDate);

                    google.script.run
                        .withSuccessHandler(function (infResult) {
                            if (!infResult.ok || !infResult.stores) {
                                tbody.innerHTML = '<tr><td colspan="8">No data for this date</td></tr>';
                                return;
                            }
                            processNetworkINFData(infResult.stores);
                        })
                        .withFailureHandler(function (err) {
                            tbody.innerHTML = '<tr><td colspan="8">Error: ' + err + '</td></tr>';
                        })
                        .getINFItemsForDate(latestDate);
                })
                .withFailureHandler(function (err) {
                    tbody.innerHTML = '<tr><td colspan="8">Error: ' + err + '</td></tr>';
                })
                .getINFDates();
        }

        function processNetworkINFData(stores) {
            networkINFItems = [];
            let totalINF = 0;
            let outOfStockCount = 0;

            for (const [storeName, storeData] of Object.entries(stores)) {
                const items = storeData.items || [];
                for (const item of items) {
                    networkINFItems.push({
                        ...item,
                        storeName: storeName,
                        storeNumber: storeData.store_id || ''
                    });
                    totalINF += item.inf_count || 0;
                    if (item.stock === 0) outOfStockCount++;
                }
            }

            // Populate store filter using DOM
            const storeFilter = document.getElementById('inf-store-filter');
            const storeNames = [...new Set(networkINFItems.map(i => i.storeName))].sort();
            storeFilter.innerHTML = '';
            const allOpt = document.createElement('option');
            allOpt.value = '';
            allOpt.textContent = 'All Stores (' + storeNames.length + ')';
            storeFilter.appendChild(allOpt);
            storeNames.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s;
                opt.textContent = s;
                storeFilter.appendChild(opt);
            });

            // Render summary
            const avgINF = networkINFItems.length > 0 ? (totalINF / networkINFItems.length).toFixed(1) : 0;
            const summaryEl = document.getElementById('network-inf-summary');
            summaryEl.innerHTML = '<div class="summary-item"><div class="value">' + Object.keys(stores).length + '</div><div class="label">Stores</div></div>' +
                '<div class="summary-item"><div class="value">' + networkINFItems.length + '</div><div class="label">Total INF Items</div></div>' +
                '<div class="summary-item"><div class="value">' + totalINF + '</div><div class="label">Total INF Count</div></div>' +
                '<div class="summary-item"><div class="value">' + avgINF + '</div><div class="label">Avg INF/Item</div></div>' +
                '<div class="summary-item"><div class="value" style="color: #a71d2a;">' + outOfStockCount + '</div><div class="label">Out of Stock</div></div>';

            filterNetworkINF();
        }

        function filterNetworkINF() {
            const searchTerm = (document.getElementById('inf-search')?.value || '').toLowerCase();
            const storeFilter = document.getElementById('inf-store-filter')?.value || '';
            const stockFilter = document.getElementById('inf-stock-filter')?.value || '';
            const sortValue = document.getElementById('inf-sort')?.value || 'inf-desc';

            networkINFFiltered = networkINFItems.filter(item => {
                if (searchTerm && !item.name?.toLowerCase().includes(searchTerm) && !item.sku?.includes(searchTerm)) return false;
                if (storeFilter && item.storeName !== storeFilter) return false;
                if (stockFilter === 'out' && item.stock !== 0) return false;
                if (stockFilter === 'low' && (item.stock === null || item.stock === undefined || item.stock >= 5 || item.stock === 0)) return false;
                if (stockFilter === 'ok' && (item.stock === null || item.stock === undefined || item.stock < 5)) return false;
                return true;
            });

            networkINFFiltered.sort((a, b) => {
                switch (sortValue) {
                    case 'inf-desc': return (b.inf_count || 0) - (a.inf_count || 0);
                    case 'inf-asc': return (a.inf_count || 0) - (b.inf_count || 0);
                    case 'stock-asc': return (a.stock ?? 999) - (b.stock ?? 999);
                    case 'stock-desc': return (b.stock ?? -1) - (a.stock ?? -1);
                    case 'store': return (a.storeName || '').localeCompare(b.storeName || '');
                    case 'name': return (a.name || '').localeCompare(b.name || '');
                    default: return 0;
                }
            });

            renderNetworkINFTable();
        }

        function renderNetworkINFTable() {
            const tbody = document.getElementById('network-inf-tbody');
            const countSpan = document.getElementById('network-inf-count');
            const placeholderImg = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cmVjdCBmaWxsPSIjZjBmMGYwIiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iIGZpbGw9IiM5OTkiIGZvbnQtc2l6ZT0iMTAiPk5vIEltYWdlPC90ZXh0Pjwvc3ZnPg==';

            countSpan.textContent = 'Showing ' + networkINFFiltered.length + ' of ' + networkINFItems.length + ' items';

            if (networkINFFiltered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8">No items match filters</td></tr>';
                return;
            }

            const displayItems = networkINFFiltered.slice(0, 100);
            tbody.innerHTML = '';

            displayItems.forEach(item => {
                const row = document.createElement('tr');
                const stockClass = item.stock === 0 ? 'metric-bad' : (item.stock !== null && item.stock < 5) ? 'metric-warn' : '';
                const analysisUrl = item.sku ? 'https://app.218.team/assistant/' + item.sku + '?locationId=' + item.storeNumber : '';

                row.innerHTML = '<td><img src="' + (item.image_url || placeholderImg) + '" style="width:50px;height:50px;object-fit:contain;background:white;border-radius:4px;" onerror="this.src=\'' + placeholderImg + '\'"></td>' +
                    '<td><strong>' + (item.name || 'Unknown') + '</strong><br><small style="color:#666;">SKU: ' + (item.sku || 'N/A') + '</small></td>' +
                    '<td>' + (item.storeName || '') + '</td>' +
                    '<td class="metric-bad" style="font-weight:600;">' + (item.inf_count ?? 'N/A') + '</td>' +
                    '<td class="' + stockClass + '">' + (item.stock ?? 'N/A') + '</td>' +
                    '<td>' + (item.price ? '¬£' + item.price.toFixed(2) : '-') + '</td>' +
                    '<td style="font-size:11px;">' + (item.location || '-') + '</td>' +
                    '<td>' + (analysisUrl ? '<a href="' + analysisUrl + '" target="_blank" class="product-link" style="padding:4px 8px;font-size:11px;">üîç</a>' : '') + '</td>';
                tbody.appendChild(row);
            });

            if (networkINFFiltered.length > 100) {
                const moreRow = document.createElement('tr');
                moreRow.innerHTML = '<td colspan="8" style="text-align:center;padding:12px;color:#666;">Showing first 100 of ' + networkINFFiltered.length + ' items. Use filters to narrow down.</td>';
                tbody.appendChild(moreRow);
            }
        }

        function exportNetworkINF() {
            if (networkINFFiltered.length === 0) {
                alert('No data to export');
                return;
            }

            const rows = [['Store', 'SKU', 'Product', 'INF Count', 'Stock', 'Price', 'Location', 'Barcode']];
            for (const item of networkINFFiltered) {
                rows.push([
                    item.storeName || '',
                    item.sku || '',
                    '"' + (item.name || '').replace(/"/g, '""') + '"',
                    item.inf_count ?? '',
                    item.stock ?? '',
                    item.price ?? '',
                    '"' + (item.location || '').replace(/"/g, '""') + '"',
                    item.barcode || ''
                ]);
            }

            const csv = rows.map(r => r.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'network_inf_export_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr + 'T00:00:00');
            return d.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });
        }

        window.addEventListener('load', init);
    </script>
</body>

</html>