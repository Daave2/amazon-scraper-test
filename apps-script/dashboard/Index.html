<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon Performance Dashboard</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f0f2f5;
            color: #1a1a1a;
            line-height: 1.5;
        }

        .header {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            color: white;
            padding: 20px 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .header-left h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .header-left .subtitle {
            opacity: 0.85;
            font-size: 14px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .date-picker {
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 6px;
            border: none;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            cursor: pointer;
        }

        .date-picker option {
            background: #1e3a5f;
            color: white;
        }

        .refresh-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }

        .refresh-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .card-header {
            background: #f8f9fa;
            padding: 16px 20px;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            font-size: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-body {
            padding: 20px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
        }

        .summary-item {
            text-align: center;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .summary-item .value {
            font-size: 28px;
            font-weight: 700;
            color: #1e3a5f;
        }

        .summary-item .label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        .region-section {
            margin-bottom: 24px;
        }

        .region-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e3a5f;
            margin-bottom: 12px;
            padding-left: 12px;
            border-left: 4px solid #2d5a87;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        th,
        td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .manager-cell {
            font-weight: 600;
            color: #1e3a5f;
            background: #e9f0f7 !important;
        }

        .metric-good {
            color: #0a7c42;
            background: #d4edda;
        }

        .metric-warn {
            color: #856404;
            background: #fff3cd;
        }

        .metric-bad {
            color: #a71d2a;
            background: #f8d7da;
        }

        td.metric-good,
        td.metric-warn,
        td.metric-bad {
            font-weight: 600;
            text-align: center;
        }

        .currency {
            font-family: 'SF Mono', Consolas, monospace;
            text-align: right;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }

        .timestamp {
            font-size: 12px;
            color: #666;
        }

        .history-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
        }

        /* Tab Navigation */
        .tab-nav {
            background: #fff;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            gap: 0;
            padding: 0 20px;
        }

        .tab-btn {
            padding: 14px 24px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: #1e3a5f;
            background: #f8f9fa;
        }

        .tab-btn.active {
            color: #1e3a5f;
            border-bottom-color: #2d5a87;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* INF Product Cards */
        .inf-controls {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .inf-select {
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 14px;
            min-width: 200px;
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .product-card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
        }

        .product-image {
            width: 100%;
            height: 160px;
            object-fit: contain;
            background: white;
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .product-details {
            padding: 14px;
        }

        .product-name {
            font-weight: 600;
            font-size: 14px;
            color: #1a1a1a;
            margin-bottom: 8px;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .product-sku {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }

        .product-stats {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .stat-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-inf {
            background: #f8d7da;
            color: #a71d2a;
        }

        .badge-stock {
            background: #d4edda;
            color: #0a7c42;
        }

        .badge-stock.low {
            background: #fff3cd;
            color: #856404;
        }

        .badge-stock.out {
            background: #f8d7da;
            color: #a71d2a;
        }

        .badge-price {
            background: #e9f0f7;
            color: #1e3a5f;
        }

        .product-location {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #eee;
        }

        .product-actions {
            padding: 10px 14px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
        }

        .product-link {
            display: inline-block;
            padding: 6px 12px;
            background: #1e3a5f;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .product-link:hover {
            background: #2d5a87;
        }

        .inf-empty {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .store-inf-rate {
            font-size: 14px;
            color: #666;
            margin-left: auto;
        }

        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }

            th,
            td {
                padding: 6px 4px;
                font-size: 10px;
            }

            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .header {
                flex-direction: column;
                text-align: center;
            }

            .product-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="header-left">
            <h1>üìä Amazon Performance Dashboard</h1>
            <div class="subtitle" id="report-date">Loading...</div>
        </div>
        <div class="header-right">
            <select class="date-picker" id="date-selector" onchange="loadDate(this.value)">
                <option value="">Loading dates...</option>
            </select>
            <span class="history-badge" id="history-count"></span>
            <button class="refresh-btn" onclick="exportCSV()" title="Download CSV">üì• Export</button>
            <button class="refresh-btn" onclick="init()">‚ü≥ Refresh</button>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('performance')">üè™ Performance</button>
        <button class="tab-btn" onclick="switchTab('inf')">üì¶ INF Deep Dive</button>
    </div>

    <!-- Performance Tab -->
    <div id="tab-performance" class="tab-content active">
        <div class="container">
            <!-- Summary Card -->
            <div class="card">
                <div class="card-header">
                    <span>Network Summary</span>
                    <span class="timestamp" id="last-updated"></span>
                </div>
                <div class="card-body">
                    <div class="summary-grid" id="summary-grid">
                        <div class="loading">Loading summary...</div>
                    </div>
                </div>
            </div>

            <!-- Filter Bar -->
            <div class="card" style="margin-bottom: 16px;">
                <div class="card-body"
                    style="padding: 12px 20px; display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
                    <span style="font-weight: 600; font-size: 14px;">üîç Filters:</span>
                    <select id="region-filter" onchange="applyFilters()"
                        style="padding: 6px 12px; border-radius: 6px; border: 1px solid #ddd; font-size: 13px;">
                        <option value="">All Regions</option>
                    </select>
                    <select id="manager-filter" onchange="applyFilters()"
                        style="padding: 6px 12px; border-radius: 6px; border: 1px solid #ddd; font-size: 13px;">
                        <option value="">All Managers</option>
                    </select>
                    <button onclick="clearFilters()"
                        style="padding: 6px 12px; background: #f0f2f5; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; font-size: 13px;">Clear</button>
                    <span id="filter-count" style="color: #666; font-size: 12px;"></span>
                </div>
            </div>

            <!-- Data Tables -->
            <div class="card">
                <div class="card-header">Store Performance by Region</div>
                <div class="card-body" id="regions-container">
                    <div class="loading">Loading store data...</div>
                </div>
            </div>
        </div>
    </div><!-- End Performance Tab -->

    <!-- INF Deep Dive Tab -->
    <div id="tab-inf" class="tab-content">
        <div class="container">
            <div class="card">
                <div class="card-header">
                    <span>üì¶ INF Items Deep Dive</span>
                </div>
                <div class="card-body">
                    <div class="inf-controls">
                        <label style="font-weight: 600;">Date:</label>
                        <select id="inf-date-selector" class="inf-select" onchange="loadINFData(this.value)">
                            <option value="">Loading dates...</option>
                        </select>
                        <label style="font-weight: 600; margin-left: 16px;">Store:</label>
                        <select id="inf-store-selector" class="inf-select" onchange="renderINFProducts(this.value)">
                            <option value="">Select a store</option>
                        </select>
                        <span class="store-inf-rate" id="store-inf-rate"></span>
                    </div>
                    <div id="inf-products-container">
                        <div class="inf-empty">Select a date and store to view INF items</div>
                    </div>
                </div>
            </div>
        </div>
    </div><!-- End INF Tab -->

    <script>
        let availableDates = [];
        let currentDate = null;
        let selectedRegion = '';
        let selectedManager = '';

        function populateFilters(data) {
            const regionSelect = document.getElementById('region-filter');
            const managerSelect = document.getElementById('manager-filter');

            if (!data.regions) return;

            // Get unique regions (sorted)
            const regions = Object.keys(data.regions).filter(r => r !== 'Unknown').sort();
            regionSelect.innerHTML = '<option value="">All Regions</option>' +
                regions.map(r => `<option value="${r}">${r}</option>`).join('');

            // Get all managers
            let allManagers = new Set();
            for (const [region, managers] of Object.entries(data.regions)) {
                for (const manager of Object.keys(managers)) {
                    allManagers.add(manager);
                }
            }
            const sortedManagers = [...allManagers].sort();
            managerSelect.innerHTML = '<option value="">All Managers</option>' +
                sortedManagers.map(m => `<option value="${m}">${m}</option>`).join('');
        }

        function applyFilters() {
            selectedRegion = document.getElementById('region-filter').value;
            selectedManager = document.getElementById('manager-filter').value;

            if (lastReportData) {
                renderRegionsFiltered(lastReportData);
            }
        }

        function clearFilters() {
            document.getElementById('region-filter').value = '';
            document.getElementById('manager-filter').value = '';
            selectedRegion = '';
            selectedManager = '';
            if (lastReportData) {
                renderRegionsFiltered(lastReportData);
            }
        }

        function renderRegionsFiltered(data) {
            const regions = data.regions || {};
            let html = '';
            let storeCount = 0;

            for (const [regionName, managers] of Object.entries(regions)) {
                if (regionName === 'Unknown') continue;
                if (selectedRegion && regionName !== selectedRegion) continue;

                let regionHtml = '';
                let hasVisibleStores = false;

                for (const [managerName, stores] of Object.entries(managers)) {
                    if (selectedManager && managerName !== selectedManager) continue;

                    hasVisibleStores = true;
                    storeCount += stores.length;

                    stores.forEach((store, idx) => {
                        if (idx === 0) {
                            regionHtml += `<tr><td class="manager-cell" rowspan="${stores.length}">${managerName}</td>`;
                        } else {
                            regionHtml += '<tr>';
                        }
                        regionHtml += `<td>${store.store || ''}</td>`;
                        regionHtml += `<td class="${getMetricClass(store.inf_y, 1.5, 3, false)}">${formatPercent(store.inf_y)}</td>`;
                        regionHtml += `<td class="${getMetricClass(store.inf_wtd, 1.5, 3, false)}">${formatPercent(store.inf_wtd)}</td>`;
                        regionHtml += `<td class="${getMetricClass(store.lates_y, 0.5, 2, false)}">${formatPercent(store.lates_y)}</td>`;
                        regionHtml += `<td class="${getMetricClass(store.lates_wtd, 0.5, 2, false)}">${formatPercent(store.lates_wtd)}</td>`;
                        regionHtml += `<td class="${getMetricClass(store.uph_y, 90, 80, true)}">${store.uph_y || '-'}</td>`;
                        regionHtml += `<td class="${getMetricClass(store.uph_wtd, 90, 80, true)}">${store.uph_wtd || '-'}</td>`;
                        regionHtml += `<td class="${getMetricClass(store.avc_y, 95, 85, true)}">${formatPercent(store.avc_y)}</td>`;
                        regionHtml += `<td class="${getMetricClass(store.avc_wtd, 95, 85, true)}">${formatPercent(store.avc_wtd)}</td>`;
                        regionHtml += `<td class="${getMetricClass(store.avr_wtd, 95, 85, true)}">${formatPercent(store.avr_wtd)}</td>`;
                        regionHtml += `<td class="currency">${formatCurrency(store.wasted_payroll)}</td>`;
                        regionHtml += `<td class="currency">${formatCurrency(store.missed_sales)}</td>`;
                        regionHtml += '</tr>';
                    });
                }

                if (hasVisibleStores) {
                    html += `<div class="region-section">`;
                    html += `<div class="region-title">${regionName} Region</div>`;
                    html += `<table><thead><tr>
                        <th>Manager</th><th>Store</th>
                        <th>INF Y</th><th>INF WTD</th>
                        <th>Lates Y</th><th>Lates WTD</th>
                        <th>UPH Y</th><th>UPH WTD</th>
                        <th>AvC Y</th><th>AvC WTD</th><th>AvR WTD</th>
                        <th>Wasted ¬£</th><th>Missed ¬£</th>
                    </tr></thead><tbody>${regionHtml}</tbody></table></div>`;
                }
            }

            if (!html) {
                html = '<div class="loading">No matching stores</div>';
            }

            document.getElementById('regions-container').innerHTML = html;
            document.getElementById('filter-count').innerText = `Showing ${storeCount} stores`;
        }


        function formatCurrency(value) {
            if (!value || value === 0) return '-';
            return '¬£' + Math.round(value).toLocaleString();
        }

        function formatPercent(value) {
            if (value === null || value === undefined) return '-';
            return value.toFixed(1) + '%';
        }

        function getMetricClass(value, goodThreshold, badThreshold, higherIsBetter) {
            if (value === null || value === undefined) return '';
            if (higherIsBetter) {
                if (value >= goodThreshold) return 'metric-good';
                if (value < badThreshold) return 'metric-bad';
                return 'metric-warn';
            } else {
                if (value <= goodThreshold) return 'metric-good';
                if (value > badThreshold) return 'metric-bad';
                return 'metric-warn';
            }
        }

        function formatDateDisplay(dateStr) {
            const d = new Date(dateStr);
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return days[d.getDay()] + ' ' + d.getDate() + ' ' + months[d.getMonth()];
        }

        function populateDatePicker(dates, selectedDate) {
            const selector = document.getElementById('date-selector');
            selector.innerHTML = dates.map(d =>
                `<option value="${d}" ${d === selectedDate ? 'selected' : ''}>${formatDateDisplay(d)}</option>`
            ).join('');

            document.getElementById('history-count').innerText = dates.length + ' days';
        }

        function renderSummary(data) {
            const summary = data.summary || {};
            const html = `
        <div class="summary-item">
          <div class="value">${data.stores_count || 0}</div>
          <div class="label">Stores</div>
        </div>
        <div class="summary-item">
          <div class="value">${formatPercent(summary.avg_inf)}</div>
          <div class="label">Avg INF</div>
        </div>
        <div class="summary-item">
          <div class="value">${formatPercent(summary.avg_lates)}</div>
          <div class="label">Avg Lates</div>
        </div>
        <div class="summary-item">
          <div class="value">${summary.avg_uph ? Math.round(summary.avg_uph) : '-'}</div>
          <div class="label">Avg UPH</div>
        </div>
        <div class="summary-item">
          <div class="value">${formatCurrency(summary.total_wasted_payroll)}</div>
          <div class="label">Wasted Payroll</div>
        </div>
        <div class="summary-item">
          <div class="value">${formatCurrency(summary.total_missed_sales)}</div>
          <div class="label">Missed Sales</div>
        </div>
      `;
            document.getElementById('summary-grid').innerHTML = html;
        }

        function renderRegions(data) {
            const regions = data.regions || {};
            let html = '';

            for (const [regionName, managers] of Object.entries(regions)) {
                if (regionName === 'Unknown') continue;

                html += `<div class="region-section">`;
                html += `<div class="region-title">${regionName} Region</div>`;
                html += `<table>`;
                html += `<thead><tr>
          <th>Manager</th>
          <th>Store</th>
          <th>INF Y</th>
          <th>INF WTD</th>
          <th>Lates Y</th>
          <th>Lates WTD</th>
          <th>UPH Y</th>
          <th>UPH WTD</th>
          <th>AvC Y</th>
          <th>AvC WTD</th>
          <th>AvR WTD</th>
          <th>Wasted ¬£</th>
          <th>Missed ¬£</th>
        </tr></thead>`;
                html += '<tbody>';

                for (const [managerName, stores] of Object.entries(managers)) {
                    stores.forEach((store, idx) => {
                        html += '<tr>';
                        if (idx === 0) {
                            html += `<td class="manager-cell" rowspan="${stores.length}">${managerName}</td>`;
                        }
                        html += `<td>${store.store || ''}</td>`;
                        html += `<td class="${getMetricClass(store.inf_y, 1.5, 3, false)}">${formatPercent(store.inf_y)}</td>`;
                        html += `<td class="${getMetricClass(store.inf_wtd, 1.5, 3, false)}">${formatPercent(store.inf_wtd)}</td>`;
                        html += `<td class="${getMetricClass(store.lates_y, 0.5, 2, false)}">${formatPercent(store.lates_y)}</td>`;
                        html += `<td class="${getMetricClass(store.lates_wtd, 0.5, 2, false)}">${formatPercent(store.lates_wtd)}</td>`;
                        html += `<td class="${getMetricClass(store.uph_y, 90, 80, true)}">${store.uph_y || '-'}</td>`;
                        html += `<td class="${getMetricClass(store.uph_wtd, 90, 80, true)}">${store.uph_wtd || '-'}</td>`;
                        html += `<td class="${getMetricClass(store.avc_y, 95, 85, true)}">${formatPercent(store.avc_y)}</td>`;
                        html += `<td class="${getMetricClass(store.avc_wtd, 95, 85, true)}">${formatPercent(store.avc_wtd)}</td>`;
                        html += `<td class="${getMetricClass(store.avr_wtd, 95, 85, true)}">${formatPercent(store.avr_wtd)}</td>`;
                        html += `<td class="currency">${formatCurrency(store.wasted_payroll)}</td>`;
                        html += `<td class="currency">${formatCurrency(store.missed_sales)}</td>`;
                        html += '</tr>';
                    });
                }

                html += '</tbody></table></div>';
            }

            if (!html) {
                html = '<div class="loading">No region data available</div>';
            }

            document.getElementById('regions-container').innerHTML = html;
        }

        function loadDate(dateStr) {
            currentDate = dateStr;
            document.getElementById('summary-grid').innerHTML = '<div class="loading">Loading...</div>';
            document.getElementById('regions-container').innerHTML = '<div class="loading">Loading...</div>';

            google.script.run
                .withSuccessHandler(handleReportData)
                .withFailureHandler(handleError)
                .getReportForDate(dateStr);
        }

        function handleReportData(data) {
            if (!data.ok) {
                document.getElementById('summary-grid').innerHTML = `<div class="error">${data.message}</div>`;
                document.getElementById('regions-container').innerHTML = '';
                return;
            }

            currentDate = data.report_date;
            document.getElementById('report-date').innerText = `Report for: ${formatDateDisplay(data.report_date)}`;
            document.getElementById('last-updated').innerText = `Updated: ${new Date(data.timestamp).toLocaleString()}`;

            if (data.available_dates) {
                populateDatePicker(data.available_dates, currentDate);
            }

            populateFilters(data);
            renderSummary(data);
            renderRegionsFiltered(data);
        }

        function handleError(error) {
            document.getElementById('summary-grid').innerHTML = `<div class="error">Error: ${error.message}</div>`;
        }

        function init() {
            google.script.run
                .withSuccessHandler(handleReportData)
                .withFailureHandler(handleError)
                .getLatestReportData();
        }

        // CSV Export functionality
        let lastReportData = null;

        function exportCSV() {
            if (!lastReportData || !lastReportData.regions) {
                alert('No data to export. Please wait for data to load.');
                return;
            }

            const regions = lastReportData.regions;
            const rows = [];

            // Header
            rows.push([
                'Region', 'Manager', 'Store',
                'INF Yesterday', 'INF WTD',
                'Lates Yesterday', 'Lates WTD',
                'UPH Yesterday', 'UPH WTD',
                'AvC Yesterday', 'AvC WTD', 'AvR WTD',
                'Wasted Payroll', 'Missed Sales'
            ].join(','));

            // Data rows
            for (const [regionName, managers] of Object.entries(regions)) {
                for (const [managerName, stores] of Object.entries(managers)) {
                    for (const store of stores) {
                        rows.push([
                            `"${regionName}"`,
                            `"${managerName}"`,
                            `"${store.store || ''}"`,
                            store.inf_y ?? '',
                            store.inf_wtd ?? '',
                            store.lates_y ?? '',
                            store.lates_wtd ?? '',
                            store.uph_y ?? '',
                            store.uph_wtd ?? '',
                            store.avc_y ?? '',
                            store.avc_wtd ?? '',
                            store.avr_wtd ?? '',
                            store.wasted_payroll ?? '',
                            store.missed_sales ?? ''
                        ].join(','));
                    }
                }
            }

            const csv = rows.join('\n');
            const filename = `performance_report_${currentDate || 'export'}.csv`;
            downloadFile(csv, filename, 'text/csv');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Store report data for export
        const originalHandleReportData = handleReportData;
        handleReportData = function (data) {
            lastReportData = data;
            originalHandleReportData(data);
        };

        // ===== INF Deep Dive Functions =====
        let currentINFData = null;

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.includes(tabName === 'performance' ? 'Performance' : 'INF'));
            });

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById('tab-' + tabName).classList.add('active');

            // Load INF dates on first switch to INF tab
            if (tabName === 'inf' && !currentINFData) {
                loadINFDates();
            }
        }

        function loadINFDates() {
            google.script.run
                .withSuccessHandler(function (result) {
                    const select = document.getElementById('inf-date-selector');
                    if (result.ok && result.dates && result.dates.length > 0) {
                        select.innerHTML = result.dates.map((d, i) =>
                            `<option value="${d}" ${i === 0 ? 'selected' : ''}>${formatDate(d)}</option>`
                        ).join('');
                        // Auto-load first date
                        loadINFData(result.dates[0]);
                    } else {
                        select.innerHTML = '<option value="">No INF data available</option>';
                        document.getElementById('inf-products-container').innerHTML =
                            '<div class="inf-empty">No INF data has been collected yet. Run an INF analysis to populate this data.</div>';
                    }
                })
                .withFailureHandler(function (err) {
                    console.error('Failed to load INF dates:', err);
                })
                .getINFDates();
        }

        function loadINFData(dateKey) {
            if (!dateKey) return;

            const container = document.getElementById('inf-products-container');
            container.innerHTML = '<div class="loading">Loading INF data...</div>';

            google.script.run
                .withSuccessHandler(function (result) {
                    if (result.ok && result.stores) {
                        currentINFData = result.stores;
                        renderStoreSelector(result.stores);
                    } else {
                        container.innerHTML = '<div class="inf-empty">' + (result.message || 'No data available') + '</div>';
                    }
                })
                .withFailureHandler(function (err) {
                    container.innerHTML = '<div class="inf-empty">Error loading data: ' + err + '</div>';
                })
                .getINFItemsForDate(dateKey);
        }

        function renderStoreSelector(stores) {
            const select = document.getElementById('inf-store-selector');
            const storeNames = Object.keys(stores).sort();

            select.innerHTML = '<option value="">Select a store (' + storeNames.length + ' stores)</option>' +
                storeNames.map(name => {
                    const itemCount = stores[name].items?.length || 0;
                    return `<option value="${name}">${name} (${itemCount} items)</option>`;
                }).join('');

            document.getElementById('inf-products-container').innerHTML =
                '<div class="inf-empty">Select a store to view INF items</div>';
            document.getElementById('store-inf-rate').textContent = '';
        }

        function renderINFProducts(storeName) {
            const container = document.getElementById('inf-products-container');
            const rateSpan = document.getElementById('store-inf-rate');

            if (!storeName || !currentINFData || !currentINFData[storeName]) {
                container.innerHTML = '<div class="inf-empty">Select a store to view INF items</div>';
                rateSpan.textContent = '';
                return;
            }

            const storeData = currentINFData[storeName];
            const items = storeData.items || [];
            const infRate = storeData.inf_rate;

            rateSpan.textContent = infRate ? `INF Rate: ${infRate}%` : '';

            if (items.length === 0) {
                container.innerHTML = '<div class="inf-empty">No INF items found for this store</div>';
                return;
            }

            const cardsHtml = items.map(item => {
                // Determine stock badge style
                let stockBadgeClass = 'badge-stock';
                let stockValue = item.stock ?? 'N/A';
                if (typeof stockValue === 'number') {
                    if (stockValue === 0) stockBadgeClass += ' out';
                    else if (stockValue < 5) stockBadgeClass += ' low';
                }

                // Build location string
                let locationStr = '';
                if (item.location) {
                    const loc = item.location;
                    const parts = [];
                    if (loc.aisle) parts.push('Aisle ' + loc.aisle);
                    if (loc.bay) parts.push('Bay ' + loc.bay);
                    if (loc.shelf) parts.push('Shelf ' + loc.shelf);
                    locationStr = parts.join(' ‚Ä¢ ') || loc.raw || '';
                }

                // Analysis app link
                const analysisUrl = item.sku ?
                    `https://app.218.team/assistant/${item.sku}?locationId=${storeData.store_number || ''}` : '';

                // Placeholder image (base64 encoded simple gray box)
                const placeholderImg = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cmVjdCBmaWxsPSIjZjBmMGYwIiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iIGZpbGw9IiM5OTkiIGZvbnQtc2l6ZT0iMTAiPk5vIEltYWdlPC90ZXh0Pjwvc3ZnPg==';
                const imgSrc = item.image_url || placeholderImg;

                return `
                <div class="product-card">
                    <img class="product-image" 
                         src="${imgSrc}" 
                         alt="${(item.name || 'Product').replace(/"/g, '&quot;')}"
                         onerror="this.onerror=null; this.src='${placeholderImg}';" />
                    <div class="product-details">
                        <div class="product-name">${item.name || 'Unknown Product'}</div>
                        <div class="product-sku">SKU: ${item.sku || 'N/A'}${item.barcode ? ` ‚Ä¢ EAN: ${item.barcode}` : ''}</div>
                        <div class="product-stats">
                            <span class="stat-badge badge-inf">INF: ${item.inf_count ?? 'N/A'}</span>
                            <span class="stat-badge ${stockBadgeClass}">Stock: ${stockValue}</span>
                            ${item.price ? `<span class="stat-badge badge-price">¬£${item.price.toFixed(2)}</span>` : ''}
                        </div>
                        ${(item.orders_impacted || item.replacement_pct || item.picking_window) ? `
                        <div class="product-stats" style="margin-top: 6px;">
                            ${item.orders_impacted ? `<span class="stat-badge" style="background:#e9f0f7;color:#1e3a5f;">üì¶ ${item.orders_impacted} orders</span>` : ''}
                            ${item.replacement_pct ? `<span class="stat-badge" style="background:${item.replacement_pct >= 50 ? '#d4edda' : '#fff3cd'};color:${item.replacement_pct >= 50 ? '#0a7c42' : '#856404'};">üîÑ ${item.replacement_pct}% replaced</span>` : ''}
                            ${item.picking_window ? `<span class="stat-badge" style="background:#f0f2f5;color:#495057;">‚è∞ ${item.picking_window}</span>` : ''}
                        </div>` : ''}
                        ${item.location ? `<div class="product-location">üìç ${item.location}</div>` : ''}
                        ${item.discontinued ? '<div class="product-location" style="color: #a71d2a;">‚ö†Ô∏è Discontinued / Not Ranged</div>' : ''}
                    </div>
                    ${analysisUrl ? `
                    <div class="product-actions">
                        <a href="${analysisUrl}" target="_blank" class="product-link">üîç Analyze</a>
                        ${item.barcode ? `<button onclick="navigator.clipboard.writeText('${item.barcode}');this.textContent='Copied!';setTimeout(()=>this.textContent='üìã Copy EAN',1500)" class="product-link" style="margin-left:8px;background:#6c757d;border:none;cursor:pointer;">üìã Copy EAN</button>` : ''}
                    </div>` : ''}
                </div>`;
            }).join('');

            container.innerHTML = `<div class="product-grid">${cardsHtml}</div>`;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr + 'T00:00:00');
            return d.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });
        }

        window.addEventListener('load', init);
    </script>
</body>

</html>