name: Daily Master Schedule (Perf & INF)

on:
  # Scheduled runs at 9am, 12pm, 2pm, 5pm, 8pm (UTC/UK Winter Time)
  schedule:
    - cron: '0 9,12,14,17,20 * * *'
  
  # Manual trigger
  workflow_dispatch:
  
  # API trigger
  repository_dispatch:
    types:
      - run-full-scrape

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'

jobs:
  daily-master-run:
    runs-on: ubuntu-latest
    timeout-minutes: 90  # Extended timeout for combined run

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install Python dependencies
      run: pip install -r requirements.txt

    - name: Install Playwright browsers
      run: python -m playwright install --with-deps chromium

    - name: Generate Runtime Config
      env:
        # Secrets for Login & APIs
        LOGIN_URL:       ${{ secrets.LOGIN_URL }}
        SECRET_KEY:      ${{ secrets.SECRET_KEY }}
        LOGIN_EMAIL:     ${{ secrets.LOGIN_EMAIL }}
        LOGIN_PASSWORD:  ${{ secrets.LOGIN_PASSWORD }}
        OTP_SECRET_KEY:  ${{ secrets.OTP_SECRET_KEY }}
        
        # Webhooks
        CHAT_WEBHOOK_URL: ${{ secrets.CHAT_WEBHOOK_URL }}
        APPS_SCRIPT_WEBHOOK_URL: ${{ secrets.APPS_SCRIPT_WEBHOOK_URL }}
        
        # External APIs
        MORRISONS_API_KEY: ${{ secrets.MORRISONS_API_KEY }}
        MORRISONS_BEARER_TOKEN_URL: ${{ secrets.MORRISONS_BEARER_TOKEN_URL }}
        
        # Dashboard Config - CRITICAL FIX
        DASHBOARD_GIST_ID: "267134a093e5906af4aeaf1c6eb50ea1"
        GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
        
      run: |
        cat > config.json <<JSON
        {
          "debug": false,
          "login_url":       "${LOGIN_URL}",
          "secret_key":      "${SECRET_KEY}",
          "login_email":     "${LOGIN_EMAIL}",
          "login_password":  "${LOGIN_PASSWORD}",
          "otp_secret_key":  "${OTP_SECRET_KEY}",
          "chat_webhook_url": "${CHAT_WEBHOOK_URL}",
          "apps_script_webhook_url": "${APPS_SCRIPT_WEBHOOK_URL}",
          
          "dashboard_gist_id": "${DASHBOARD_GIST_ID}",
          "gist_token": "${GIST_TOKEN}",
          
          "max_concurrency": 55,
          "page_timeout_ms": 90000,
          "element_wait_timeout_ms": 20000,
          
          "morrisons_api_key": "${MORRISONS_API_KEY}",
          "morrisons_bearer_token_url": "${MORRISONS_BEARER_TOKEN_URL}",
          "enrich_stock_data": false,
          
          "auto_concurrency": {
            "enabled": true,
            "min_concurrency": 1,
            "max_concurrency": 50,
            "cpu_upper_threshold": 90,
            "cpu_lower_threshold": 75
          },
          
          "inventory_system_url": "https://amazon-product-analysis-584939250419.us-west1.run.app/assistant/{sku}?locationId={store_number}"
        }
        JSON

    # 1. PERFOMANCE SCRAPE
    - name: Run Performance Scraper
      run: python scraper.py --date-mode today
      env:
        # Pass tokens just in case scripts read env vars directly
        GIST_TOKEN: ${{ secrets.GIST_TOKEN }}

    # 2. INF SCRAPE (Runs after Performance)
    - name: Run INF Scraper
      if: success() || failure()  # Try to run INF even if Perf has minor issues, but usually we want success
      run: python inf_scraper.py
      env:
        GIST_TOKEN: ${{ secrets.GIST_TOKEN }}

    - name: Upload Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: daily-run-output-${{ github.run_id }}
        path: |
          output/
          app.log
          state.json
        retention-days: 7
